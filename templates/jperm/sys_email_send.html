{% extends 'base.html' %}
{% load mytags %}
{% block self_head_css_js %}
    <link href="/static/css/plugins/datepicker/datepicker3.css" rel="stylesheet">
    <link href="/static/css/plugins/chosen/chosen.css" rel="stylesheet">
    <script src="/static/js/plugins/chosen/chosen.jquery.js"></script>
{% endblock %}

{% block content %}
    {% include 'nav_cat_bar.html' %}
    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="row">
            <div class="col-sm-10">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>邮件发送信息详情</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                            <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                                <i class="fa fa-wrench"></i>
                            </a>
                            <a class="close-link">
                                <i class="fa fa-times"></i>
                            </a>
                        </div>
                    </div>

                    <div class="ibox-content">
                        <form id="emailForm" method="post" class="form-horizontal">
                            {% if error %}
                                <div class="alert alert-warning text-center">{{ error }}</div>
                            {% endif %}
                            {% if msg %}
                                <div class="alert alert-success text-center">{{ msg }}</div>
                            {% endif %}
                            <div class="form-group">
                                <label for="email_template" class="col-sm-2 control-label">邮件模板<span class="red-fonts">*</span></label>
                                <div class="col-sm-8">
                                    <select id="email_template" name="email_template" class=" form-control m-b ">
                                        {% for emails in emails_obj %}
                                            <option value="{{ emails.id }}" {% if emails.id in email_obj.id %}selected{% endif %}>{{ emails.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="user_list" class="col-sm-2 control-label">收件人<span class="red-fonts">*</span></label>
                                <div class="col-sm-8">
                                    <select name="user_list" id="user_list" data-placeholder="请选择收件员工" class="chosen-select form-control m-b" multiple>
                                        {% for user in users_obj %}
                                                <option value="{{ user.id }}" {% if user.id in emails_selected %}selected{% endif %}>{{ user.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="cc_user_id" class="col-sm-2 control-label">抄送</label>
                                <div class="col-sm-8">
                                    <select name="cc_user_id" id="cc_user_id" data-placeholder="请选择抄送员工" class="chosen-select form-control m-b" multiple>
                                        {% for cuser in users_obj %}
                                            <option value="{{ cuser.id }}" {% if cuser.id in cc_selected %}selected{% endif %}>{{ cuser.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="form-group hide">
                                <input id="another_users" name="another_users" type="text">
                            </div>

                            {% if users %}
                            <div>
                                <div class="form-group ">
                                    <label for="entry_time" class="col-sm-2 control-label">入职时间<span class="red-fonts">*</span></label>
                                    <div class="col-sm-8">
                                        <input id="entry_time" name="entry_time" type="date">
                                    </div>
                                </div>
                                <div class="hr-line-dashed"></div>
                                <div><h4>入职人员信息</h4><span class="red-fonts">（默认归属区域入职，外地员工北京入职需勾选） </span></div>
                                <table class="table table-striped table-bordered table-hover " id="editable" >
                                    <thead>
                                        <tr>
                                            <th class="text-center">
                                                <input type="checkbox" id="check_all" onclick="checkAll('check_all', 'checked')">
                                            </th>
                                            <th class="text-center">部门</th>
                                            <th class="text-center">姓名</th>
                                            <th class="text-center">岗位</th>
                                            <th class="text-center">区域</th>
                                            <th class="text-center">领带人</th>
                                            <th class="text-center">入职时间</th>
                                            <th class="text-center">用工方式</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for user in users %}
                                            <tr class="gradeX">
                                                <td class="text-center">
                                                    <input type="checkbox"  name="checked" value="{{ user.id }}">
                                                </td>
                                                <td class="text-center" title="{% for user_group in user.group.all %} {{ user_group.name }} {% endfor %}"> {{ user.group.name  }} </td>
                                                <td class="text-center"><a href="{% url 'user_detail' %}?id={{ user.id }}"> {{ user.name }} </a></td>
                                                <td class="text-center"> {{ user.job }} </td>
                                                <td class="text-center"> {{ user.position.name }} </td>
                                                <td class="text-center"> {{ user.guide.name }} </td>
                                                <td class="text-center"> {{ user.entry_time | date:"Y-m-d " }} </td>
                                                <td class="text-center"> {{ user.emp_way }} </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>

                                </table>
                            </div>
                            {% endif %}

                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-sm-4 col-sm-offset-2">
                                    <a class="btn btn-white" onclick="window.close();">关闭</a>
{#                                    <a class="btn btn-primary" type="submit">确认</a>#}
                                    <button class="btn btn-primary" type="submit">确认</button>
                                </div>
                            </div>
                        </form>
                        <div class="progress hide" id="email_progress">
                            <div id="load_progress" class="progress-bar  progress-bar-striped active" role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                                <span class="sr-only"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block self_footer_js %}
<script src="/static/js/jquery.shiftcheckbox.js"></script>
<script>
$(document).ready(function(){
        $("tbody tr").shiftcheckbox({
            checkboxSelector: 'input:checkbox',
            selectAll: $('#select_all'),
            ignoreClick: 'a'
        });
        $('.shiftCheckbox').shiftcheckbox();
});
var config = {
                '.chosen-select'           : {},
                '.chosen-select-deselect'  : {allow_single_deselect:true},
                '.chosen-select-no-single' : {disable_search_threshold:10},
                '.chosen-select-no-results': {no_results_text:'Oops, nothing found!'},
                '.chosen-select-width'     : {width:"95%"}
            };

for (var selector in config) {
    $(selector).chosen(config[selector]);
}

    $('#emailForm').validator({
    timely: 2,
    theme: "yellow_right_effect",
    rules: {
        type_m: function(element){
                    return  $("#M").is(":checked");
            }
    },
{#    fields: {#}
{#        "user_list": {#}
{#            rule: "required",#}
{#            tip: "收件人",#}
{#            msg: {required: "必须填写"}#}
{#        }#}
{#    },#}
    valid: function(form) {
        var check_array = [];
        if (confirm("请确认如下信息是否正确!")){
            $(".gradeX input:checked").each(function() {
                    check_array.push($(this).attr("value"))
                });
            $("#another_users").val(check_array);
            form.submit();
            HideProgress();
        }
    }
});

    function HideProgress() {
        $('#email_progress').removeClass('hide');
        load_time(1,'');
    }

    function load_time(i,w) {
        if (i<100){
            w = String(i) + "%";
            $('#load_progress').css('width', w)
        }
        setTimeout(function () {
            i+=10;
            load_time(i,w);
        },50)
    }

</script>
    <script src="/static/js/cropper/cropper.min.js"></script>
    <script src="/static/js/datapicker/bootstrap-datepicker.js"></script>
{% endblock %}
