{% extends 'base.html' %}
{% load mytags %}
{% block content %}
{% include 'nav_cat_bar.html' %}

<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5> 赛事管理 </h5>
                    <div class="ibox-tools">
                        <a class="collapise-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                        <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                            <i class="fa fa-wrench"></i>
                        </a>
                        <a class="close-link">
                            <i class="fa fa-times"></i>
                        </a>
                    </div>
                </div>

                <div class="ibox-content">
                    <form id="user_form">
                        <div class="">
                            <div class="col-sm-8" style="padding-left: 0">
                                <a href="{% url 'match_add' %}" class="btn btn-sm btn-info"> 新增赛事 </a>
                                <a href="{% url 'match_select' %}" class="btn btn-sm btn-primary"> 查看赛事实况 </a>
                                <a href="{% url 'match_sync' %}" class="btn btn-sm btn-warning"> 同步信息 </a>
                                <a href="{% url 'match_info_sync' %}" class="btn btn-sm btn-default "> 同步赛事实况 </a>
                                <a href="{% url 'do_bid_confirm_run' %}" class="btn btn-sm btn-info "> 测试任务 </a>
{#                                <a id="user_mail" class="btn btn-sm btn-warning "> 邮件通知 </a>#}
{#                                <a class="btn btn-warning btn-sm" data-toggle="modal" data-target="#emailModal">邮件通知</a>#}
                            </div>

                            <div class="col-sm-3" style="padding-right: 0">
                                <form id="search_form" method="get" action="" class="pull-right mail-search">
                                    <div class="input-group">
                                        <input type="text" class="form-control input-sm" id="search_input" name="keyword" placeholder="Search">
                                        <div class="input-group-btn">
                                            <button id='search_btn' type="submit" class="btn btn-sm btn-primary">
                                                -搜索-
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
    {#                        <a id="del_btn" class="btn btn-sm btn-danger "> 删除所选 </a>#}

                        </div>
                        {% if error %}
                            <div class="alert alert-warning text-center">{{ error }}</div>
                        {% endif %}
    {#                    {% if msg %}#}
    {#                        <div class="alert alert-success text-center">{{ msg }}</div>#}
    {#                    {% endif %}#}
                        <table class="table table-striped table-bordered table-hover " id="editable" >
                            <thead>
                                <tr>
                                    <th class="text-center">
                                        <input type="checkbox" id="check_all" onclick="checkAll('check_all', 'checked')">
                                    </th>
                                    <th class="text-center">比赛时间</th>
                                    <th class="text-center">主队</th>
                                    <th class="text-center">客队</th>
                                    <th class="text-center">让球</th>
                                    <th class="text-center">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for matchs in match_obj %}
                                <tr class="gradeX">
                                    <td class="text-center">
                                        <input type="checkbox" name="checked" value="{{ matchs.id }}">
                                    </td>
                                    <td class="text-center"> {{ matchs.time|date:"Y-m-d H:i:s" }} </td>
                                    <td class="text-left">
                                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                        <img width="60" height="40" src="{{ matchs.home_team.flag_address }}">
                                        {{ matchs.home_team.name  }}
                                    </td>
                                    <td class="text-left">
                                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                        <img width="60" height="40" src="{{ matchs.visit_team.flag_address }}">
                                        {{ matchs.visit_team.name }}
                                    </td>
                                    <td class="text-center"> {{ matchs.concede_goal }} </td>

                                    <td class="text-center">
                                        <a class="btn btn-primary btn-sm" data-toggle="modal" onclick="set_match_id({{ matchs.id }})" data-target="#EnterScore">录入比分</a>
                                        <a href="{% url 'match_settlement' %}?match_id={{ matchs.id }}" class="btn btn-sm btn-danger">结算</a>
                                        <a href="{% url 'match_balance_bak' %}?match_id={{ matchs.id }}" class="btn btn-sm btn-warning">回滚</a>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="dataTables_info" id="editable_info" role="status" aria-live="polite">
                                    Showing {{ users.start_index }} to {{ users.end_index }} of {{ p.count }} entries
                                </div>
                            </div>
                            {% include 'paginator.html' %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="EnterScore" tabindex="-1" role="dialog" aria-labelledby="ScoreLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="ScoreLabel">录入赛事比分</h4>
            </div>
            <div class="modal-body" style="height: 200px">
                <form method="post" class="form-horizontal" >
                    <div>
                        <input class="form-control hide" id="match_id" type="text" />
                        <div class="form-group">
                            <label class="control-label col-sm-2 col-lg-2 " for="home_score" style="padding-top: 6px">主队得分</label>
                            <div class=" col-sm-8 col-lg-8 ">
                                <input class=" form-control" id="home_score" type="text" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-sm-2 col-lg-2 " for="visit_score" style="padding-top: 6px">客队得分</label>
                            <div class=" col-sm-8 col-lg-8 ">
                                <input class=" form-control" id="visit_score" type="text" />
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-4 col-sm-offset-5" style="margin-top: 10px">
                                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" id="score_add" >提交</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block self_head_css_js %}
    {% load staticfiles %}
    <script src="{% static 'js/jquery.shiftcheckbox.js' %}"></script>
{% endblock %}
{% block self_footer_js %}
<script>
    $(document).ready(function(){
        $('#score_add').click(function () {
            var match_id = $("#match_id").val();
            var home_score = $("#home_score").val();
            var visit_score = $("#visit_score").val();
            if(!home_score && !visit_score){
                alert("请输入有效得分！")
            }else {
                $.post("{% url 'match_score_add' %}",
                        {
                            match_id: match_id,
                            home_score: home_score,
                            visit_score: visit_score
                        },
                        function (data) {
{#                            var r=JSON.parse(data);#}
                            alert(data);
                            $("#EnterScore").modal("hide");
                        }
                )
            }
        });
        $('.del').click(function(){
            var row = $(this).closest('tr');
            if (confirm("确定删除")) {
            $.get(
                    $(this).attr('value'),
                    {},
                    function(data){
{#                        row.remove();#}
                        alert(data);
                        location.reload()
                    }
            )}
        });

        $("tbody tr").shiftcheckbox({
            checkboxSelector: 'input:checkbox',
            selectAll: $('#select_all'),
            ignoreClick: 'a'
        });
        $('.shiftCheckbox').shiftcheckbox();
    });

function change_info(){
        var args = $("#user_form").serialize();
        window.location = "{% url 'user_list' %}?" + args
    }

function set_match_id(id) {
    $('#match_id').val(id)
}
</script>
{% endblock %}